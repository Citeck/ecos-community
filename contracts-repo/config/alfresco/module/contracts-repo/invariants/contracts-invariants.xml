<?xml version="1.0" encoding="UTF-8"?>
<invariants xmlns="http://www.citeck.ru/ecos/invariants/1.0">

    <imports>
        <import uri="http://www.alfresco.org/model/content/1.0" prefix="cm" />
        <import uri="http://www.citeck.ru/model/content/classification/tk/1.0" prefix="tk" />
        <import uri="http://www.citeck.ru/model/contracts/1.0" prefix="contracts" />
        <import uri="http://www.citeck.ru/model/payments/1.0" prefix="payments" />
        <import uri="http://www.citeck.ru/model/content/idocs/1.0" prefix="idocs" />
    </imports>

    <type name="contracts:agreement">
        <property name="parent">
            <invariant on="default" language="criteria">
                <criterion attribute="path" predicate="path-equals" value="/app:company_home/st:sites/cm:contracts/cm:documentLibrary/cm:contracts" />
            </invariant>
        </property>
        <property name="contracts:contractWith">
            <invariant on="mandatory" language="explicit">true</invariant>
        </property>
        <association name="contracts:agreementLegalEntity">
            <invariant on="mandatory" language="explicit">true</invariant>
        </association>
        <association name="contracts:contractor">
            <invariant on="mandatory" language="explicit">true</invariant>
            <invariant on="value-title" language="javascript">value.properties["idocs:fullOrganizationName"]</invariant>
        </association>
        <property name="tk:kind">
            <invariant on="mandatory" language="explicit">true</invariant>
            <!-- <invariant on="title" language="javascript">if (navigator.languages[0].length == 0 || navigator.languages[0].includes("en")) {"Type of contract:";} else if (navigator.languages[0].includes("ru")) {"Вид договора:";}
            </invariant> -->
        </property>
        <property name="contracts:agreementNumber">
            <invariant on="mandatory" language="explicit">true</invariant>
        </property>

        <!-- <property name="contracts:agreementDate">
            <invariant on="value" language="javascript">node.properties["contracts:duration"].setFullYear(value.getFullYear() + 1)</invariant>
        </property> -->
        <property name="contracts:duration">
            <invariant on="default" language="javascript">node.properties["contracts:agreementDate"].setFullYear(node.properties["contracts:agreementDate"].getFullYear() + 1)</invariant>
        </property>
        <association name="contracts:agreementCurrency">
            <invariant on="default" language="explicit">workspace://SpacesStore/currency-rur</invariant>
        </association>
        <property name="contracts:agreementAmount">
            <!-- <invariant on="valid" language="javascript" description="Это поле должно содержать положительное число.">value < 0 ? true : false</invariant> -->
            <!-- <invariant on="valid" language="javascript" description="Не верный формат">/^\d+([,\.]\d{1,3}|)$/.test(value)</invariant> -->
        </property>
        <property name="contracts:VAT">
            <invariant on="valid" language="javascript" description="Это поле должно содержать положительно число.">
                new RegExp('\u005e[\u0030-\u0039]*\u0024', 'igm').test(value)
            </invariant>
        </property>
        <property name="cm:content">
            <invariant on="relevant" language="javascript">node.properties["dms:updateContent"] == false</invariant>
            <invariant on="mandatory" language="javascript">node.properties["dms:updateContent"] == false</invariant>
        </property>
    </type>

    <type name="payments:payment">
        <property name="payments:paymentFor">
            <invariant on="default" language="explicit">client</invariant>
            <invariant on="mandatory" language="explicit">true</invariant>
        </property>
        <association name="payments:payer">
            <invariant on="mandatory" language="explicit">true</invariant>
        </association>
        <property name="payments:paymentNumber">
            <invariant on="mandatory" language="explicit">true</invariant>
        </property>
        <association name="payments:beneficiary">
            <invariant on="mandatory" language="explicit">true</invariant>
        </association>
        <property name="payments:beneficiaryType">
            <invariant on="default" language="explicit">resident</invariant>
        </property>
        <property name="payments:paymentAccount">
            <invariant on="mandatory" language="explicit">true</invariant>
        </property>
        <association name="payments:currency">
            <invariant on="default" language="explicit">workspace://SpacesStore/currency-rur</invariant>
        </association>
        <property name="payments:paymentAmount">
            <invariant on="valid" language="javascript" description="Это поле не должно содержать отрицательное число.">value >= 0 ? true : false</invariant>
        </property>
        <property name="payments:paymentVAT">
            <invariant on="valid" language="javascript" description="Это поле не должно содержать отрицательное число.">value >= 0 ? true : false</invariant>
            <invariant on="mandatory" language="explicit">true</invariant>
            <invariant on="default" language="javascript">0</invariant>
        </property>
        <property name="cm:content">
            <invariant on="relevant" language="javascript">node.properties["dms:updateContent"] == false</invariant>
            <invariant on="mandatory" language="javascript">node.properties["dms:updateContent"] == false</invariant>
        </property>
        <association name="payments:beneficiary">
            <invariant on="value" language="javascript">node.assocs["payments:basis"][0].assocs["contracts:contractor"][0]</invariant>
        </association>
        <association name="payments:payer">
            <invariant on="value" language="javascript">
                if (node.assocs["payments:basis"][0].type == "{http://www.citeck.ru/model/contracts/1.0}agreement") {
                    node.assocs["payments:basis"][0].assocs["contracts:agreementLegalEntity"][0];
                } else if (node.assocs["payments:basis"][0].type == "{http://www.citeck.ru/model/contracts/1.0}closingDocument") {
                    node.assocs["payments:basis"][0].assocs["idocs:legalEntity"][0];
                }
                </invariant>
        </association>
    </type>

    <type name="payments:paymentDraft">
        <association name="payments:currency">
            <invariant on="default" language="explicit">workspace://SpacesStore/currency-rur</invariant>
        </association>
        <property name="payments:typePayment">
            <invariant on="default" language="explicit">advance</invariant>
        </property>
        <property name="payments:paymentAmount">
            <invariant on="valid" language="javascript" description="Это поле не должно содержать отрицательное число.">false == new RegExp('\u005e[\u0030-\u0039]*\u0024', 'igm').test(value) ? false : true</invariant>
        </property>
        <property name="payments:paymentVAT">
            <invariant on="valid" language="javascript" description="Это поле не должно содержать отрицательное число.">value >= 0 ? true : false</invariant>
        </property>
    </type>

    <type name="contracts:closingDocument">
        <!-- <association name="contracts:closingDocumentAgreement">
            <invariant on="mandatory" language="explicit">true</invariant>
        </association> -->
        <property name="tk:kind">
            <invariant on="mandatory" language="explicit">true</invariant>
            <!-- <invariant on="title" language="javascript">if (navigator.languages[0].length == 0 || navigator.languages[0].includes("en")) {"Document type:";} else if (navigator.languages[0].includes("ru")) {"Вид документа:";}
</invariant> -->
        </property>
        <property name="contracts:closingDocumentNumber">
            <invariant on="mandatory" language="explicit">true</invariant>
        </property>
        <property name="cm:content">
            <invariant on="relevant" language="javascript">node.properties["dms:updateContent"] == false</invariant>
            <invariant on="mandatory" language="javascript">node.properties["dms:updateContent"] == false</invariant>
        </property>
        <association name="contracts:contractor">
            <invariant on="mandatory" language="explicit">true</invariant>
            <invariant on="value" language="javascript">
                node.assocs["contracts:closingDocumentAgreement"][0].assocs["contracts:contractor"][0]
            </invariant>
        </association>
        <association name="idocs:legalEntity">
            <invariant on="mandatory" language="explicit">true</invariant>
            <invariant on="value" language="javascript">
                node.assocs["contracts:closingDocumentAgreement"][0].assocs["contracts:agreementLegalEntity"][0]
            </invariant>
        </association>
        <association name="contracts:closingDocumentCurrency">
            <invariant on="mandatory" language="explicit">true</invariant>
            <invariant on="default" language="explicit">workspace://SpacesStore/currency-rur</invariant>
            <invariant on="value" language="javascript">
                node.assocs["contracts:closingDocumentAgreement"][0].assocs["contracts:agreementCurrency"][0]
            </invariant>
        </association>
    </type>

    <type name="contracts:supplementaryAgreement">
        <association name="contracts:mainAgreement">
            <invariant on="mandatory" language="explicit">true</invariant>
        </association>
        <association name="contracts:agreementLegalEntity">
            <invariant on="mandatory" language="explicit">true</invariant>
        </association>
        <property name="contracts:agreementNumber">
            <invariant on="mandatory" language="explicit">true</invariant>
        </property>
        <association name="contracts:contractor">
            <invariant on="mandatory" language="explicit">true</invariant>
            <invariant on="value-title" language="javascript">value.properties["idocs:fullOrganizationName"]</invariant>
        </association>
        <!-- <property name="tk:kind">
            <invariant on="title" language="javascript">if (navigator.languages[0].length == 0 || navigator.languages[0].includes("en")) {"Type of add'l agreement:";} else if (navigator.languages[0].includes("ru")) {"Вид доп. соглашения:";}
</invariant>
        </property> -->
        <association name="contracts:agreementCurrency">
            <invariant on="default" language="explicit">workspace://SpacesStore/currency-rur</invariant>
        </association>
        <property name="contracts:agreementAmount">
            <invariant on="valid" language="javascript" description="Это поле должно содержать неотрицательное число.">value >= 0 ? true : false</invariant>
        </property>
        <property name="contracts:VAT">
            <invariant on="valid" language="javascript" description="Это поле должно содержать неотрицательное число.">value >= 0 ? true : false</invariant>
        </property>
        <property name="cm:content">
            <invariant on="relevant" language="javascript">node.properties["dms:updateContent"] == false</invariant>
            <invariant on="mandatory" language="javascript">node.properties["dms:updateContent"] == false</invariant>
        </property>
    </type>

</invariants>