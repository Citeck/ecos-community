<?xml version="1.0" encoding="UTF-8"?>
<invariants xmlns="http://www.citeck.ru/ecos/invariants/1.0">

    <imports>
        <import uri="http://www.alfresco.org/model/dictionary/1.0" prefix="d" />
        <import uri="http://www.alfresco.org/model/content/1.0" prefix="cm" />
        <import uri="http://www.citeck.ru/model/products-and-services/1.0" prefix="pas" />
    </imports>

    <type name="pas:pasEntityCopied">
        <property name="cm:title">
            <invariant on="value" language="javascript">
                <![CDATA[(function () {
                    var valueToSet = value;
                    var pasEntityOriginal = node.impl().getAttribute("pas:pasEntityOriginalAssoc").value();
                    if (pasEntityOriginal) {
                        valueToSet = pasEntityOriginal.properties["cm:title"];
                    }
                    return valueToSet;
                })()]]>
            </invariant>
        </property>
        <property name="cm:description">
            <invariant on="value" language="javascript">
                <![CDATA[(function () {
                    var valueToSet = value;
                    var pasEntityOriginal = node.impl().getAttribute("pas:pasEntityOriginalAssoc").value();
                    if (pasEntityOriginal) {
                        valueToSet = pasEntityOriginal.properties["cm:description"];
                    }
                    return valueToSet;
                })()]]>
            </invariant>
        </property>
        <property name="pas:type">
            <invariant on="value" language="javascript">
                <![CDATA[(function () {
                    var valueToSet = value;
                    var pasEntityOriginal = node.impl().getAttribute("pas:pasEntityOriginalAssoc").value();
                    if (pasEntityOriginal) {
                        valueToSet = pasEntityOriginal.properties["pas:type"];
                    }
                    return valueToSet;
                })()]]>
            </invariant>
        </property>
        <property name="pas:pricePerUnit">
            <invariant on="value" language="javascript">
                <![CDATA[(function () {
                    var valueToSet = value;
                    var pasEntityOriginal = node.impl().getAttribute("pas:pasEntityOriginalAssoc").value();
                    if (pasEntityOriginal) {
                        valueToSet = pasEntityOriginal.properties["pas:pricePerUnit"];
                    }
                    return valueToSet;
                })()]]>
            </invariant>
        </property>
        <association name="pas:entityUnit">
            <invariant on="value" language="javascript">
                <![CDATA[(function () {
                    var valueToSet = value;
                    var copiedValue = node.impl().getAttribute("pas:pasEntityOriginalAssoc").value();
                    if (copiedValue && copiedValue.assocs["pas:entityUnit"].length > 0) {
                        valueToSet = copiedValue.assocs["pas:entityUnit"][0];
                    }
                    return valueToSet;
                })()]]>
            </invariant>
        </association>
        <association name="pas:currency">
            <invariant on="value" language="javascript">
                <![CDATA[(function () {
                    var valueToSet = value;
                    var copiedValue = node.impl().getAttribute("pas:pasEntityOriginalAssoc").value();
                    if (copiedValue && copiedValue.assocs["pas:currency"].length > 0) {
                        valueToSet = copiedValue.assocs["pas:currency"][0];
                    }
                    return valueToSet;
                })()]]>
            </invariant>
        </association>
        <!--<association name="pas:pasEntityOriginalAssoc">
            <invariant on="relevant" language="javascript">view.mode == "create"</invariant>
        </association>-->

        <property name="pas:quantity">
            <invariant on="valid" language="javascript" description="Число должно быть положительным">value > 0</invariant>
            <invariant on="mandatory" language="explicit" description="Введено некорректное значение">true</invariant>
            <invariant on="default" language="javascript">1</invariant>
        </property>
        <property name="pas:total">
            <invariant on="valid" language="javascript" description="Число должно быть неотрицательным">value >= 0</invariant>
            <invariant on="mandatory" language="explicit" description="Введено некорректное значение">true</invariant>
            <invariant on="value" language="javascript">Math.round(node.properties["pas:pricePerUnit"] * node.properties["pas:quantity"] * 10000) / 10000</invariant>
        </property>
    </type>
    <type name="pas:pasEntity">
        <property name="pas:pricePerUnit">
            <invariant on="valid" language="javascript" description="Число должно быть неотрицательным">value >= 0</invariant>
            <invariant on="mandatory" language="explicit" description="Введено некорректное значение">true</invariant>
            <invariant on="default" language="javascript">0</invariant>
        </property>
        <association name="pas:currency">
            <invariant on="mandatory" language="explicit">true</invariant>
        </association>
    </type>
    <type name="pas:pasEntityOriginal">
        <property name="pas:pricePerUnit">
            <invariant on="mandatory" language="explicit">true</invariant>
            <invariant on="valid" language="javascript"
                       description="invariants.validation.no-more-then-2-after-decimal-point">
                <![CDATA[(function() {
                        var valueStr = value.toString(),
                            index = valueStr ? valueStr.indexOf(".") : -1,
                            count = index != -1 ? valueStr.length - (index + 1) : 0;
                        return count <= 2;
                    })()]]>
            </invariant>
        </property>
    </type>
</invariants>